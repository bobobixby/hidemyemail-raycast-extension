# Product Requirements Document (PRD): Local "Hide My Email" Repair & Cookie Bypass

## 1. Overview
**Project Name:** HideMyEmail - Local Cookie Bypass Fork
**Objective:** Restore functionality to the abandoned `hidemyemail-raycast-extension` by replacing the broken SRP (Secure Remote Password) authentication flow with a manual Session Cookie injection mechanism.
**Target Audience:** Single-user (yourself), running locally via Raycast.

## 2. Problem Statement
The current extension relies on `fast-srp-hap` to authenticate with Apple servers. Apple has updated their cryptographic handshake (SRP protocol), rendering the current login implementation obsolete. As a result, users cannot log in to generate or list emails.

## 3. Proposed Solution
Switch the authentication model from **Active Login** (User/Pass -> SRP -> Session) to **Passive Injection** (User provides valid Browser Cookie -> Session).

This removes the need for cryptographic handshake logic and allows the user to leverage the long-lived sessions (up to 2 months) generated by a standard web browser.

---

## 4. Functional Requirements

### 4.1. Configuration (Preferences)
- **New Preference Field:** The extension must accept a `sessionCookie` string via Raycast Preferences.
- **Security:** The field type must be `password` so the cookie string is masked in the UI.
- **Fast Access:** The user must be able to update this string quickly without touching the code when the session expires.

### 4.2. Authentication Logic
- **Bypass Login Screen:** If the `sessionCookie` preference is populated, the `Login.tsx` component (and its sub-forms) must be skipped entirely.
- **Initialize Service:** The `iCloudService` must initialize immediately using the provided cookie string.

### 4.3. Network Layer
- **Header Injection:** Every HTTP request sent by `axios` in `connect.ts` must include the hardcoded `Cookie` header derived from preferences.
- **Cookie Jar Override:** The manual cookie header must take precedence over any cookies stored in the `tough-cookie` jar or `LocalStorage`.

### 4.4. Error Handling
- **Expiration Detection:** If the API returns a `401 Unauthorized` or `450 Authentication Required`, the extension must display a specific error message: *"Session Expired: Please update your Cookie in Preferences."*

---

## 5. Technical Specifications & Implementation Plan

### 5.1. `package.json` Updates
We will add a preference field to store the cookie.

```json
{
  "name": "sessionCookie",
  "title": "iCloud Cookie",
  "description": "The full 'Cookie' header string from icloud.com (Grab via DevTools)",
  "type": "password",
  "required": false,
  "placeholder": "Paste full Cookie header string here..."
}
```

### 5.2. `src/api/connect.ts` Refactoring
We need to modify the `init()` function in the `iCloudSession` class to inject the header.

**Changes:**
1.  Import `getPreferenceValues` from `@raycast/api`.
2.  In `iCloudSession.init()`, check for the preference.
3.  Set the default header.

```typescript
// src/api/connect.ts

// ... imports
import { getPreferenceValues } from "@raycast/api";

export class iCloudSession {
  // ... existing properties

  async init() {
    // Keep existing cookie jar logic for fallback, or comment it out.
    
    const prefs = getPreferenceValues<{ sessionCookie?: string }>();

    this.instance = wrapper(
      axios.create({
        jar: this.jar, // strictly speaking not needed if we override headers, but keeps axios happy
        timeout: 5000,
      }),
    );

    // INJECTION LOGIC
    if (prefs.sessionCookie) {
      this.instance.defaults.headers.common["Cookie"] = prefs.sessionCookie;
      // Force specific headers that usually come from login but are needed for HME
      this.instance.defaults.headers.common["Origin"] = "https://www.icloud.com";
      this.instance.defaults.headers.common["Referer"] = "https://www.icloud.com/";
    }
    
    // ... existing interceptors
  }
}
```

### 5.3. `src/components/Login.tsx` Bypass
We need to short-circuit the login form if the cookie exists.

**Changes:**
1.  Check preferences on mount.
2.  If cookie exists, instantiate `iCloudService` with a dummy ID (since we don't need the real email to make requests if we have the cookie).

```typescript
// src/components/Login.tsx
import { getPreferenceValues } from "@raycast/api";

// ... inside Login function

useEffect(() => {
  if (!effectRan.current) {
    effectRan.current = true;
    
    const prefs = getPreferenceValues<{ sessionCookie?: string }>();
    
    // FAST TRACK
    if (prefs.sessionCookie) {
      // We use a placeholder ID because we don't need to save session data to LocalStorage anymore
      const iService = new iCloudService("cookie-session-user"); 
      
      // Initialize (which sets the axios headers from step 5.2)
      iService.init().then(() => {
        onLogin(iService); // Successfully "logged in"
      });
      return; 
    }

    // ... Old logic for checking LocalStorage/SRP login
  }
}, []);
```

---

## 6. Fast Exchange Strategy (The Workflow)

Since cookies expire, the workflow for swapping them must be frictionless.

### 6.1. The "Extraction" Protocol (User Guide)
To ensure the cookie lasts **2 months** instead of 7 days:
1.  Open **Chrome Incognito** or **Safari Private Window**.
2.  Go to `icloud.com` and log in.
3.  **Crucial:** When asked for 2FA, click **"Trust this browser"**.
4.  Open Developer Tools (`F12` or `Cmd+Opt+I`) -> **Network Tab**.
5.  Filter for `validate` or `account` (pick any request to `setup.icloud.com` or `icloud.com`).
6.  Click the request -> **Request Headers**.
7.  Right-click the line that starts with `Cookie:` -> **Copy value**.

### 6.2. The "Update" Protocol (In Raycast)
When the extension stops working (Toast says "Session Expired"):
1.  Perform **Extraction** (Step 6.1).
2.  Press `Cmd + ,` (Command Comma) while the extension command is open. This instantly opens the **Command Preferences**.
3.  Paste the new string into the `iCloud Cookie` field.
4.  Press `Esc`.
5.  Run the command again.

### 6.3. Code Cleanup (Optional but Recommended)
To prevent confusion and potential errors, delete the following files which are no longer used in this "Bypass" architecture:
- `src/components/forms/LoginForm.tsx`
- `src/components/forms/TwoFactorAuthForm.tsx`
- The `SRP` logic inside `src/api/connect.ts` (specifically `srpAuthenticate`, `validate2FACode`).

---

## 7. Migration Steps Summary

1.  **Clone** the repo locally.
2.  **Edit `package.json`**: Add the `sessionCookie` preference.
3.  **Edit `src/api/connect.ts`**: Add logic to inject `prefs.sessionCookie` into `axios` headers.
4.  **Edit `src/components/Login.tsx`**: Add logic to detect preference and skip to `onLogin()`.
5.  **Run `npm install`**.
6.  **Import** into Raycast.
7.  **Paste Cookie** and run.